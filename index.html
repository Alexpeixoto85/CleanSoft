<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4361ee">
    <title>CleanSoft Mobile</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== VARIÁVEIS DE DESIGN ===== */
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --card-bg: #ffffff;
            --shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 15px 50px rgba(0, 0, 0, 0.12);
            --radius: 16px;
            --radius-sm: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --gradient-primary: linear-gradient(135deg, #4361ee, #3a0ca3);
            --gradient-success: linear-gradient(135deg, #4cc9f0, #4895ef);
            --gradient-warning: linear-gradient(135deg, #f8961e, #f3722c);
            --gradient-danger: linear-gradient(135deg, #f72585, #b5179e);
        }

        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--dark);
            line-height: 1.5;
            min-height: 100vh;
            padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* ===== APP HEADER MODERNO ===== */
        .app-header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px 20px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.3);
            border-bottom-left-radius: 25px;
            border-bottom-right-radius: 25px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logo-text h1 {
            font-size: 1.4rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .logo-text p {
            font-size: 0.8rem;
            opacity: 0.9;
            font-weight: 400;
        }

        .date-time {
            text-align: right;
        }

        .date-time .date {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .date-time .time {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .page-title {
            font-size: 1.3rem;
            font-weight: 600;
            padding: 10px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== BOTTOM NAVIGATION MODERNA ===== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-around;
            padding: 12px 10px;
            box-shadow: 0 -5px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-top-left-radius: 25px;
            border-top-right-radius: 25px;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--gray);
            transition: var(--transition);
            flex: 1;
            max-width: 80px;
            position: relative;
        }

        .nav-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
            background: var(--light-gray);
            margin-bottom: 6px;
        }

        .nav-item span {
            font-size: 0.75rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active .nav-icon {
            background: var(--gradient-primary);
            color: white;
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.4);
        }

        .nav-indicator {
            position: absolute;
            top: -8px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--primary);
            opacity: 0;
        }

        .nav-item.active .nav-indicator {
            opacity: 1;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            animation: fadeInUp 0.5s ease;
        }

        .page {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== STATS CARDS MODERNAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 22px 18px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:nth-child(1)::before { background: var(--primary); }
        .stat-card:nth-child(2)::before { background: var(--secondary); }
        .stat-card:nth-child(3)::before { background: var(--warning); }
        .stat-card:nth-child(4)::before { background: var(--danger); }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card:active {
            transform: scale(0.98);
        }

        .stat-icon {
            width: 54px;
            height: 54px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            font-size: 1.4rem;
            color: white;
            flex-shrink: 0;
        }

        .stat-card:nth-child(1) .stat-icon { background: var(--gradient-primary); }
        .stat-card:nth-child(2) .stat-icon { background: var(--gradient-success); }
        .stat-card:nth-child(3) .stat-icon { background: var(--gradient-warning); }
        .stat-card:nth-child(4) .stat-icon { background: var(--gradient-danger); }

        .stat-info h3 {
            font-size: 1.6rem;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .stat-info p {
            font-size: 0.85rem;
            color: var(--gray);
            font-weight: 500;
        }

        /* ===== QUICK ACTIONS ===== */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 30px;
        }

        .action-btn {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--dark);
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: none;
            width: 100%;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1) 0%, rgba(58, 12, 163, 0.05) 100%);
            opacity: 0;
            transition: var(--transition);
        }

        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .action-btn:hover::after {
            opacity: 1;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .action-btn i {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--primary);
            transition: var(--transition);
        }

        .action-btn:hover i {
            transform: scale(1.1);
        }

        .action-btn span {
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
        }

        /* ===== CARDS MODERNAS ===== */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 25px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 18px;
            border-bottom: 2px solid var(--light-gray);
        }

        .card-header h2 {
            font-size: 1.4rem;
            color: var(--dark);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h2 i {
            color: var(--primary);
        }

        /* ===== BOTÕES MODERNOS ===== */
        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: var(--transition);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .btn:hover::after {
            opacity: 1;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            padding: 0;
            border-radius: 12px;
            background: var(--light-gray);
            color: var(--dark);
        }

        .btn-icon:hover {
            background: var(--primary);
            color: white;
        }

        /* ===== LISTS MODERNAS ===== */
        .list {
            list-style: none;
        }

        .list-item {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            background: white;
        }

        .list-item:hover {
            background: #f8f9ff;
            transform: translateX(5px);
        }

        .list-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .list-item-content h3 {
            font-size: 1rem;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .list-item-content p {
            font-size: 0.9rem;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .list-item-actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
        }

        .icon-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .icon-btn.edit { color: var(--primary); }
        .icon-btn.edit:hover { background: var(--primary); color: white; }
        .icon-btn.delete { color: var(--danger); }
        .icon-btn.delete:hover { background: var(--danger); color: white; }
        .icon-btn.view { color: var(--success); }
        .icon-btn.view:hover { background: var(--success); color: white; }
        .icon-btn.whatsapp { color: #25D366; }
        .icon-btn.whatsapp:hover { background: #25D366; color: white; }

        /* ===== STATUS BADGES MODERNOS ===== */
        .status {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-pendente {
            background: rgba(248, 150, 30, 0.1);
            color: #f8961e;
        }

        .status-aprovado {
            background: rgba(76, 201, 240, 0.1);
            color: #4cc9f0;
        }

        .status-concluido {
            background: rgba(67, 97, 238, 0.1);
            color: #4361ee;
        }

        .status-cancelado {
            background: rgba(247, 37, 133, 0.1);
            color: #f72585;
        }

        .status-andamento {
            background: rgba(114, 9, 183, 0.1);
            color: #7209b7;
        }

        .status-agendado {
            background: rgba(72, 149, 239, 0.1);
            color: #4895ef;
        }

        .status-enviado {
            background: rgba(58, 12, 163, 0.1);
            color: #3a0ca3;
        }

        /* ===== FORMS MODERNOS ===== */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236c757d' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            padding-right: 48px;
        }

        /* ===== MODAL MODERNO ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 24px 24px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: var(--card-bg);
            z-index: 1;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--dark);
            font-weight: 700;
        }

        .close-modal {
            background: var(--light-gray);
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 24px;
            border-top: 2px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            position: sticky;
            bottom: 0;
            background: var(--card-bg);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .empty-state h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        /* ===== FLOATING ACTION BUTTON ===== */
        .fab {
            position: fixed;
            bottom: 100px;
            right: 25px;
            width: 64px;
            height: 64px;
            border-radius: 20px;
            background: var(--gradient-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            box-shadow: 0 10px 30px rgba(67, 97, 238, 0.5);
            border: none;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 15px 40px rgba(67, 97, 238, 0.6);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* ===== SEARCH & FILTERS ===== */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 18px 24px 18px 50px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius);
            font-size: 1rem;
            background: white;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-size: 1.2rem;
        }

        .filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-select {
            flex: 1;
            min-width: 140px;
            padding: 14px 16px;
            border: 2px solid var(--light-gray);
            border-radius: var(--radius-sm);
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-select:focus {
            border-color: var(--primary);
            outline: none;
        }

        /* ===== SETTINGS PAGE ===== */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            color: var(--dark);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid var(--light-gray);
            font-size: 1.2rem;
            font-weight: 700;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border-radius: var(--radius);
            object-fit: cover;
            border: 3px dashed var(--light-gray);
            padding: 10px;
            display: block;
            margin: 0 auto 20px;
            transition: var(--transition);
        }

        .logo-preview:hover {
            border-color: var(--primary);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: block;
            margin-bottom: 20px;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .backup-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 24px;
        }

        .backup-option {
            background: white;
            border-radius: var(--radius);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid transparent;
        }

        .backup-option:hover {
            border-color: var(--primary);
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        .backup-option i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: var(--primary);
        }

        .backup-option h4 {
            margin-bottom: 10px;
            color: var(--dark);
            font-weight: 700;
        }

        .backup-option p {
            font-size: 0.85rem;
            color: var(--gray);
            line-height: 1.4;
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-notification {
            position: fixed;
            top: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 18px 28px;
            border-radius: var(--radius);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            font-weight: 600;
            max-width: 90%;
            text-align: center;
            animation: slideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toast-notification.success {
            background: var(--gradient-success);
        }

        .toast-notification.error {
            background: var(--gradient-danger);
        }

        .toast-notification.warning {
            background: var(--gradient-warning);
        }

        .toast-notification.info {
            background: var(--gradient-primary);
        }

        @keyframes slideDown {
            from { top: 90px; opacity: 0; }
            to { top: 120px; opacity: 1; }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 380px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .quick-actions {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .backup-options {
                grid-template-columns: 1fr;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .modal-body {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <div class="header-top">
            <div class="logo-container">
                <div id="logoPreview" class="logo-icon">
                    <i class="fas fa-spray-can-sparkles"></i>
                </div>
                <div class="logo-text">
                    <h1 id="empresaNome">Clean<span style="color: #4cc9f0">Soft</span></h1>
                    <p id="empresaSlogan">Lavagem Premium & Seco</p>
                </div>
            </div>
            <div class="date-time">
                <div id="currentDate" class="date">--/--/----</div>
                <div id="currentTime" class="time">--:--</div>
            </div>
        </div>
        <div class="page-title">
            <i class="fas fa-home"></i>
            <span id="pageTitle">Dashboard</span>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Dashboard -->
        <section id="dashboard" class="page active">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="showPage('clientes')">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalClientes">0</h3>
                        <p>Clientes</p>
                    </div>
                </div>
                <div class="stat-card" onclick="showPage('orcamentos')">
                    <div class="stat-icon">
                        <i class="fas fa-file-invoice-dollar"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalOrcamentos">0</h3>
                        <p>Orçamentos</p>
                    </div>
                </div>
                <div class="stat-card" onclick="showPage('ordens')">
                    <div class="stat-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalOrdens">0</h3>
                        <p>Ordens</p>
                    </div>
                </div>
                <div class="stat-card" onclick="showPage('agendamentos')">
                    <div class="stat-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3 id="totalAgendamentos">0</h3>
                        <p>Hoje</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2><i class="fas fa-bolt"></i> Ações Rápidas</h2>
                <div class="quick-actions">
                    <button class="action-btn" onclick="showClienteForm()">
                        <i class="fas fa-user-plus"></i>
                        <span>Novo Cliente</span>
                    </button>
                    <button class="action-btn" onclick="showOrcamentoForm()">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Novo Orçamento</span>
                    </button>
                    <button class="action-btn" onclick="showOrdemForm()">
                        <i class="fas fa-clipboard-check"></i>
                        <span>Nova Ordem</span>
                    </button>
                    <button class="action-btn" onclick="showAgendamentoForm()">
                        <i class="fas fa-calendar-plus"></i>
                        <span>Agendar</span>
                    </button>
                </div>
            </div>

            <!-- Recent Activities -->
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-history"></i> Atividades Recentes</h2>
                    <button class="btn btn-icon" onclick="loadRecentActivities()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <ul class="list" id="recentActivities">
                    <div class="empty-state">
                        <i class="fas fa-clock"></i>
                        <h3>Carregando atividades...</h3>
                        <p>As atividades recentes aparecerão aqui</p>
                    </div>
                </ul>
            </div>
        </section>

        <!-- Clientes -->
        <section id="clientes" class="page">
            <div class="search-box">
                <input type="text" id="searchCliente" class="search-input" placeholder="Buscar clientes...">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-users"></i> Clientes</h2>
                    <button class="btn btn-primary" onclick="showClienteForm()">
                        <i class="fas fa-plus"></i> Novo
                    </button>
                </div>
                <ul class="list" id="listaClientes">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Nenhum cliente encontrado</h3>
                        <p>Adicione seu primeiro cliente</p>
                        <button class="btn btn-primary" onclick="showClienteForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Adicionar Cliente
                        </button>
                    </div>
                </ul>
            </div>
        </section>

        <!-- Orçamentos -->
        <section id="orcamentos" class="page">
            <div class="filter-bar">
                <select id="filterStatusOrcamento" class="filter-select">
                    <option value="">Todos os status</option>
                    <option value="pendente">Pendente</option>
                    <option value="aprovado">Aprovado</option>
                    <option value="recusado">Recusado</option>
                    <option value="enviado">Enviado</option>
                </select>
                <select id="filterClienteOrcamento" class="filter-select">
                    <option value="">Todos os clientes</option>
                </select>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-file-invoice-dollar"></i> Orçamentos</h2>
                    <button class="btn btn-primary" onclick="showOrcamentoForm()">
                        <i class="fas fa-plus"></i> Novo
                    </button>
                </div>
                <ul class="list" id="listaOrcamentos">
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>Nenhum orçamento</h3>
                        <p>Crie seu primeiro orçamento</p>
                        <button class="btn btn-primary" onclick="showOrcamentoForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Orçamento
                        </button>
                    </div>
                </ul>
            </div>
        </section>

        <!-- Ordens -->
        <section id="ordens" class="page">
            <div class="filter-bar">
                <select id="filterStatusOrdem" class="filter-select">
                    <option value="">Todos os status</option>
                    <option value="pendente">Pendente</option>
                    <option value="andamento">Em Andamento</option>
                    <option value="concluido">Concluído</option>
                    <option value="cancelado">Cancelado</option>
                </select>
                <select id="filterPrioridadeOrdem" class="filter-select">
                    <option value="">Todas as prioridades</option>
                    <option value="alta">Alta</option>
                    <option value="media">Média</option>
                    <option value="baixa">Baixa</option>
                </select>
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-clipboard-list"></i> Ordens de Serviço</h2>
                    <button class="btn btn-primary" onclick="showOrdemForm()">
                        <i class="fas fa-plus"></i> Nova
                    </button>
                </div>
                <ul class="list" id="listaOrdens">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Nenhuma ordem</h3>
                        <p>Crie sua primeira ordem de serviço</p>
                        <button class="btn btn-primary" onclick="showOrdemForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Ordem
                        </button>
                    </div>
                </ul>
            </div>
        </section>

        <!-- Agendamentos -->
        <section id="agendamentos" class="page">
            <div class="filter-bar">
                <select id="filterStatusAgendamento" class="filter-select">
                    <option value="">Todos os status</option>
                    <option value="agendado">Agendado</option>
                    <option value="confirmado">Confirmado</option>
                    <option value="concluido">Concluído</option>
                    <option value="cancelado">Cancelado</option>
                </select>
                <input type="date" id="filterDataAgendamento" class="filter-select">
            </div>
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-calendar-alt"></i> Agendamentos</h2>
                    <button class="btn btn-primary" onclick="showAgendamentoForm()">
                        <i class="fas fa-plus"></i> Novo
                    </button>
                </div>
                <ul class="list" id="listaAgendamentos">
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Nenhum agendamento</h3>
                        <p>Agende seu primeiro serviço</p>
                        <button class="btn btn-primary" onclick="showAgendamentoForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Agendar Serviço
                        </button>
                    </div>
                </ul>
            </div>
        </section>

        <!-- Configurações -->
        <section id="configuracoes" class="page">
            <div class="card">
                <div class="card-header">
                    <h2><i class="fas fa-cog"></i> Configurações</h2>
                </div>
                
                <div class="settings-section">
                    <h3>Informações da Empresa</h3>
                    <form id="empresaForm">
                        <div class="form-group">
                            <label for="empresaNomeInput">Nome da Empresa *</label>
                            <input type="text" id="empresaNomeInput" class="form-control" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="empresaSloganInput">Slogan</label>
                            <input type="text" id="empresaSloganInput" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="empresaTelefoneInput">Telefone</label>
                            <input type="tel" id="empresaTelefoneInput" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="empresaEmailInput">E-mail</label>
                            <input type="email" id="empresaEmailInput" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label for="empresaEnderecoInput">Endereço</label>
                            <textarea id="empresaEnderecoInput" class="form-control" rows="2"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="empresaCNPJInput">CNPJ</label>
                            <input type="text" id="empresaCNPJInput" class="form-control">
                        </div>
                        
                        <div class="form-group">
                            <label>Logo da Empresa</label>
                            <div class="file-input-wrapper">
                                <button type="button" class="btn btn-outline" style="width: 100%;">
                                    <i class="fas fa-upload"></i> Escolher Logo
                                </button>
                                <input type="file" id="logoUpload" accept="image/*" onchange="previewLogo(event)">
                            </div>
                            <div id="logoPreviewContainer" style="display: none;">
                                <img id="logoPreviewImg" class="logo-preview" src="" alt="Logo Preview">
                                <button type="button" class="btn btn-danger" onclick="removeLogo()" style="margin-top: 15px; width: 100%;">
                                    <i class="fas fa-trash"></i> Remover Logo
                                </button>
                            </div>
                            <small style="color: var(--gray); display: block; text-align: center; margin-top: 10px;">Tamanho recomendado: 400x400px</small>
                        </div>
                        
                        <button type="submit" class="btn btn-success" style="width: 100%; padding: 16px;">
                            <i class="fas fa-save"></i> Salvar Informações
                        </button>
                    </form>
                </div>
                
                <div class="settings-section">
                    <h3>Backup & Restauração</h3>
                    <p style="margin-bottom: 20px; color: var(--gray); text-align: center;">Faça backup dos seus dados ou restaure de um backup anterior.</p>
                    
                    <div class="backup-options">
                        <div class="backup-option" onclick="exportBackup()">
                            <i class="fas fa-file-export"></i>
                            <h4>Exportar Backup</h4>
                            <p>Salve todos os dados em um arquivo JSON</p>
                        </div>
                        
                        <div class="backup-option" onclick="importBackup()">
                            <i class="fas fa-file-import"></i>
                            <h4>Importar Backup</h4>
                            <p>Restaurar dados de um arquivo JSON</p>
                        </div>
                        
                        <div class="backup-option" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i>
                            <h4>Exportar para Excel</h4>
                            <p>Exportar dados em formato Excel</p>
                        </div>
                        
                        <div class="backup-option" onclick="clearAllData()">
                            <i class="fas fa-trash-alt"></i>
                            <h4>Limpar Dados</h4>
                            <p>Remover todos os dados do sistema</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 25px; padding: 20px; background: var(--light-gray); border-radius: var(--radius-sm);">
                        <h4 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-database"></i> Informações do Banco de Dados
                        </h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0;">
                            <span>Clientes:</span>
                            <span id="dbClientesCount" class="status status-aprovado">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0;">
                            <span>Orçamentos:</span>
                            <span id="dbOrcamentosCount" class="status status-aprovado">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0;">
                            <span>Ordens:</span>
                            <span id="dbOrdensCount" class="status status-aprovado">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding: 8px 0;">
                            <span>Agendamentos:</span>
                            <span id="dbAgendamentosCount" class="status status-aprovado">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--gray);">
                            <strong>Total:</strong>
                            <strong id="dbTotalCount" class="status status-concluido">0 registros</strong>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" data-page="dashboard">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-home"></i>
            </div>
            <span>Início</span>
        </a>
        <a href="#" class="nav-item" data-page="clientes">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-users"></i>
            </div>
            <span>Clientes</span>
        </a>
        <a href="#" class="nav-item" data-page="orcamentos">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-file-invoice-dollar"></i>
            </div>
            <span>Orçamentos</span>
        </a>
        <a href="#" class="nav-item" data-page="ordens">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <span>Ordens</span>
        </a>
        <a href="#" class="nav-item" data-page="agendamentos">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <span>Agenda</span>
        </a>
        <a href="#" class="nav-item" data-page="configuracoes">
            <span class="nav-indicator"></span>
            <div class="nav-icon">
                <i class="fas fa-cog"></i>
            </div>
            <span>Config</span>
        </a>
    </nav>

    <!-- Floating Action Button -->
    <button class="fab" id="fab" style="display: none;">
        <i class="fas fa-plus"></i>
    </button>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Novo Cliente</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Conteúdo carregado dinamicamente -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Botões carregados dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Input de arquivo para importação -->
    <input type="file" id="importFileInput" accept=".json" style="display: none;">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <script>
        // Variáveis globais
        let db;
        let currentPage = 'dashboard';
        let editingId = null;
        let currentFabAction = null;
        let empresaInfo = {
            nome: 'CleanSoft',
            slogan: 'Lavagem Premium & Seco',
            telefone: '',
            email: '',
            endereco: '',
            cnpj: '',
            logo: null
        };

        // Inicializar o app quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', function() {
            initDB();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            setupNavigation();
            setupFab();
            setupEventListeners();
            loadEmpresaInfo();
        });

        // Inicializar IndexedDB
        function initDB() {
            const request = indexedDB.open('CleanSoftMobileDB', 4);
            
            request.onerror = function(event) {
                console.error('Erro ao abrir banco de dados:', event.target.error);
                showToast('Erro ao inicializar banco de dados. Recarregue a página.', 'error');
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('Banco de dados inicializado com sucesso');
                
                // Carregar dados iniciais
                loadDashboardData();
                loadClientes();
                loadOrcamentos();
                loadOrdens();
                loadAgendamentos();
                loadFilterOptions();
                updateDatabaseStats();
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                const oldVersion = event.oldVersion;
                
                // Criar object stores
                if (!db.objectStoreNames.contains('clientes')) {
                    const store = db.createObjectStore('clientes', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('nome', 'nome', { unique: false });
                    store.createIndex('telefone', 'telefone', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('orcamentos')) {
                    const store = db.createObjectStore('orcamentos', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('clienteId', 'clienteId', { unique: false });
                    store.createIndex('status', 'status', { unique: false });
                    store.createIndex('data', 'data', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('ordens')) {
                    const store = db.createObjectStore('ordens', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('clienteId', 'clienteId', { unique: false });
                    store.createIndex('status', 'status', { unique: false });
                    store.createIndex('prioridade', 'prioridade', { unique: false });
                    store.createIndex('dataCriacao', 'dataCriacao', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('agendamentos')) {
                    const store = db.createObjectStore('agendamentos', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('clienteId', 'clienteId', { unique: false });
                    store.createIndex('status', 'status', { unique: false });
                    store.createIndex('data', 'data', { unique: false });
                    store.createIndex('hora', 'hora', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('atividades')) {
                    const store = db.createObjectStore('atividades', { keyPath: 'id', autoIncrement: true });
                    store.createIndex('data', 'data', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('empresa')) {
                    db.createObjectStore('empresa', { keyPath: 'id' });
                }
                
                // Migração de dados se necessário
                if (oldVersion > 0) {
                    console.log('Migrando banco de dados da versão', oldVersion, 'para', db.version);
                }
            };
        }

        // ========== FUNÇÕES DA EMPRESA ==========
        function loadEmpresaInfo() {
            if (!db) {
                setTimeout(loadEmpresaInfo, 100);
                return;
            }
            
            const transaction = db.transaction(['empresa'], 'readonly');
            const store = transaction.objectStore('empresa');
            const request = store.get('info');
            
            request.onsuccess = function() {
                if (request.result) {
                    empresaInfo = request.result.data;
                    
                    // Atualizar interface
                    document.getElementById('empresaNome').innerHTML = empresaInfo.nome.replace('Soft', '<span style="color: #4cc9f0">Soft</span>');
                    document.getElementById('empresaSlogan').textContent = empresaInfo.slogan || 'Lavagem Premium & Seco';
                    
                    // Preencher formulário
                    document.getElementById('empresaNomeInput').value = empresaInfo.nome;
                    document.getElementById('empresaSloganInput').value = empresaInfo.slogan || '';
                    document.getElementById('empresaTelefoneInput').value = empresaInfo.telefone || '';
                    document.getElementById('empresaEmailInput').value = empresaInfo.email || '';
                    document.getElementById('empresaEnderecoInput').value = empresaInfo.endereco || '';
                    document.getElementById('empresaCNPJInput').value = empresaInfo.cnpj || '';
                    
                    // Carregar logo se existir
                    if (empresaInfo.logo) {
                        document.getElementById('logoPreviewContainer').style.display = 'block';
                        document.getElementById('logoPreviewImg').src = empresaInfo.logo;
                        document.getElementById('logoPreview').innerHTML = `<img src="${empresaInfo.logo}" class="logo-preview">`;
                    }
                }
                
                // Configurar formulário
                document.getElementById('empresaForm').onsubmit = function(e) {
                    e.preventDefault();
                    saveEmpresaInfo();
                };
            };
        }

        function saveEmpresaInfo() {
            empresaInfo.nome = document.getElementById('empresaNomeInput').value.trim();
            empresaInfo.slogan = document.getElementById('empresaSloganInput').value.trim();
            empresaInfo.telefone = document.getElementById('empresaTelefoneInput').value.trim();
            empresaInfo.email = document.getElementById('empresaEmailInput').value.trim();
            empresaInfo.endereco = document.getElementById('empresaEnderecoInput').value.trim();
            empresaInfo.cnpj = document.getElementById('empresaCNPJInput').value.trim();
            
            if (!empresaInfo.nome) {
                showToast('O nome da empresa é obrigatório', 'warning');
                return;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const transaction = db.transaction(['empresa'], 'readwrite');
            const store = transaction.objectStore('empresa');
            const request = store.put({
                id: 'info',
                data: empresaInfo,
                updatedAt: new Date().toISOString()
            });
            
            request.onsuccess = function() {
                // Atualizar header
                document.getElementById('empresaNome').innerHTML = empresaInfo.nome.replace('Soft', '<span style="color: #4cc9f0">Soft</span>');
                document.getElementById('empresaSlogan').textContent = empresaInfo.slogan || 'Lavagem Premium & Seco';
                
                showToast('Informações da empresa salvas com sucesso!', 'success');
            };
            
            request.onerror = function() {
                showToast('Erro ao salvar informações da empresa', 'error');
            };
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                empresaInfo.logo = e.target.result;
                document.getElementById('logoPreviewContainer').style.display = 'block';
                document.getElementById('logoPreviewImg').src = empresaInfo.logo;
                document.getElementById('logoPreview').innerHTML = `<img src="${empresaInfo.logo}" class="logo-preview">`;
                
                // Salvar automaticamente
                saveEmpresaInfo();
            };
            reader.readAsDataURL(file);
        }

        function removeLogo() {
            empresaInfo.logo = null;
            document.getElementById('logoPreviewContainer').style.display = 'none';
            document.getElementById('logoPreview').innerHTML = `<i class="fas fa-spray-can-sparkles"></i>`;
            saveEmpresaInfo();
        }

        // ========== BACKUP & RESTAURAÇÃO ==========
        function exportBackup() {
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const backupData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                empresa: empresaInfo
            };
            
            // Coletar todos os dados
            const stores = ['clientes', 'orcamentos', 'ordens', 'agendamentos', 'atividades', 'empresa'];
            let completed = 0;
            
            stores.forEach(storeName => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    backupData[storeName] = request.result || [];
                    completed++;
                    
                    if (completed === stores.length) {
                        // Criar arquivo JSON
                        const dataStr = JSON.stringify(backupData, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        
                        // Criar link de download
                        const exportFileDefaultName = `cleansoft_backup_${new Date().toISOString().split('T')[0]}.json`;
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', exportFileDefaultName);
                        linkElement.click();
                        
                        showToast('Backup exportado com sucesso!', 'success');
                    }
                };
            });
        }

        function importBackup() {
            document.getElementById('importFileInput').click();
            document.getElementById('importFileInput').onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const backupData = JSON.parse(event.target.result);
                        
                        if (!confirm(`Esta ação irá substituir todos os dados atuais. ${backupData.clientes ? backupData.clientes.length : 0} clientes, ${backupData.orcamentos ? backupData.orcamentos.length : 0} orçamentos e outros registros serão importados. Continuar?`)) {
                            return;
                        }
                        
                        restoreBackup(backupData);
                    } catch (error) {
                        showToast('Erro ao ler arquivo de backup', 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
        }

        function restoreBackup(backupData) {
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Restaurar empresa info se existir
            if (backupData.empresa) {
                empresaInfo = backupData.empresa;
                
                const transaction = db.transaction(['empresa'], 'readwrite');
                const store = transaction.objectStore('empresa');
                store.put({
                    id: 'info',
                    data: empresaInfo,
                    updatedAt: new Date().toISOString()
                });
                
                // Atualizar interface
                setTimeout(() => {
                    loadEmpresaInfo();
                }, 500);
            }
            
            // Restaurar dados de cada store
            const stores = ['clientes', 'orcamentos', 'ordens', 'agendamentos', 'atividades'];
            let completed = 0;
            let totalImported = 0;
            
            stores.forEach(storeName => {
                if (backupData[storeName]) {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    
                    // Limpar store existente
                    store.clear();
                    
                    // Adicionar novos dados
                    backupData[storeName].forEach(item => {
                        store.add(item);
                        totalImported++;
                    });
                    
                    transaction.oncomplete = function() {
                        completed++;
                        if (completed === stores.length) {
                            showToast(`Backup restaurado com sucesso! ${totalImported} registros importados.`, 'success');
                            
                            // Recarregar dados
                            setTimeout(() => {
                                loadDashboardData();
                                loadClientes();
                                loadOrcamentos();
                                loadOrdens();
                                loadAgendamentos();
                                updateDatabaseStats();
                            }, 1000);
                        }
                    };
                    
                    transaction.onerror = function() {
                        completed++;
                        console.error(`Erro ao restaurar ${storeName}`);
                    };
                } else {
                    completed++;
                }
            });
        }

        function exportToExcel() {
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const workbook = XLSX.utils.book_new();
            const stores = ['clientes', 'orcamentos', 'ordens', 'agendamentos'];
            let completed = 0;
            
            stores.forEach(storeName => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    const data = request.result || [];
                    
                    if (data.length > 0) {
                        // Converter para worksheet
                        const worksheet = XLSX.utils.json_to_sheet(data.map(item => {
                            // Limpar dados para Excel
                            const cleanItem = {};
                            for (const key in item) {
                                if (key !== 'id' && typeof item[key] !== 'object') {
                                    cleanItem[key] = item[key];
                                }
                            }
                            return cleanItem;
                        }));
                        
                        XLSX.utils.book_append_sheet(workbook, worksheet, storeName);
                    }
                    
                    completed++;
                    
                    if (completed === stores.length) {
                        // Gerar arquivo Excel
                        XLSX.writeFile(workbook, `cleansoft_dados_${new Date().toISOString().split('T')[0]}.xlsx`);
                        showToast('Dados exportados para Excel com sucesso!', 'success');
                    }
                };
            });
        }

        function clearAllData() {
            if (!confirm('ATENÇÃO: Esta ação irá remover TODOS os dados do sistema (clientes, orçamentos, ordens, agendamentos). Esta ação não pode ser desfeita. Continuar?')) {
                return;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const stores = ['clientes', 'orcamentos', 'ordens', 'agendamentos', 'atividades'];
            let completed = 0;
            
            stores.forEach(storeName => {
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                store.clear();
                
                transaction.oncomplete = function() {
                    completed++;
                    if (completed === stores.length) {
                        showToast('Todos os dados foram removidos.', 'info');
                        
                        // Recarregar dados
                        setTimeout(() => {
                            loadDashboardData();
                            loadClientes();
                            loadOrcamentos();
                            loadOrdens();
                            loadAgendamentos();
                            updateDatabaseStats();
                        }, 500);
                    }
                };
            });
        }

        function updateDatabaseStats() {
            if (!db) return;
            
            const stores = ['clientes', 'orcamentos', 'ordens', 'agendamentos'];
            let total = 0;
            
            stores.forEach((storeName, index) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.count();
                
                request.onsuccess = function() {
                    const count = request.result;
                    total += count;
                    
                    // Atualizar elemento específico
                    const elementId = 'db' + storeName.charAt(0).toUpperCase() + storeName.slice(1) + 'Count';
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = count;
                    }
                    
                    // Se for o último, atualizar total
                    if (index === stores.length - 1) {
                        setTimeout(() => {
                            document.getElementById('dbTotalCount').textContent = total + ' registros';
                        }, 100);
                    }
                };
            });
        }

        // ========== FUNÇÕES EXISTENTES (ATUALIZADAS) ==========
        // Atualizar data e hora
        function updateDateTime() {
            try {
                const now = new Date();
                
                // Formatar data
                const optionsDate = { weekday: 'short', day: '2-digit', month: 'short' };
                const dateStr = now.toLocaleDateString('pt-BR', optionsDate);
                document.getElementById('currentDate').textContent = dateStr;
                
                // Formatar hora
                const timeStr = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                document.getElementById('currentTime').textContent = timeStr;
            } catch (e) {
                console.error('Erro ao atualizar data/hora:', e);
            }
        }

        // Configurar navegação
        function setupNavigation() {
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Atualizar navegação ativa
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Mostrar página correspondente
                    const pageId = this.getAttribute('data-page');
                    showPage(pageId);
                    
                    // Atualizar título
                    const pageTitle = this.querySelector('span').textContent;
                    document.getElementById('pageTitle').textContent = pageTitle;
                    
                    // Atualizar FAB
                    updateFab(pageId);
                });
            });
        }

        // Configurar FAB
        function setupFab() {
            const fab = document.getElementById('fab');
            if (fab) {
                fab.addEventListener('click', function() {
                    if (currentFabAction && typeof currentFabAction === 'function') {
                        currentFabAction();
                    }
                });
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Busca de clientes
            const searchInput = document.getElementById('searchCliente');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    loadClientes(this.value);
                });
            }
            
            // Filtros
            document.getElementById('filterStatusOrcamento')?.addEventListener('change', loadOrcamentos);
            document.getElementById('filterClienteOrcamento')?.addEventListener('change', loadOrcamentos);
            document.getElementById('filterStatusOrdem')?.addEventListener('change', loadOrdens);
            document.getElementById('filterPrioridadeOrdem')?.addEventListener('change', loadOrdens);
            document.getElementById('filterStatusAgendamento')?.addEventListener('change', loadAgendamentos);
            document.getElementById('filterDataAgendamento')?.addEventListener('change', loadAgendamentos);
        }

        // Atualizar FAB baseado na página atual
        function updateFab(pageId) {
            const fab = document.getElementById('fab');
            if (!fab) return;
            
            switch(pageId) {
                case 'clientes':
                    fab.style.display = 'flex';
                    fab.innerHTML = '<i class="fas fa-user-plus"></i>';
                    currentFabAction = showClienteForm;
                    break;
                case 'orcamentos':
                    fab.style.display = 'flex';
                    fab.innerHTML = '<i class="fas fa-file-invoice-dollar"></i>';
                    currentFabAction = showOrcamentoForm;
                    break;
                case 'ordens':
                    fab.style.display = 'flex';
                    fab.innerHTML = '<i class="fas fa-clipboard-check"></i>';
                    currentFabAction = showOrdemForm;
                    break;
                case 'agendamentos':
                    fab.style.display = 'flex';
                    fab.innerHTML = '<i class="fas fa-calendar-plus"></i>';
                    currentFabAction = showAgendamentoForm;
                    break;
                case 'configuracoes':
                    fab.style.display = 'none';
                    currentFabAction = null;
                    break;
                default:
                    fab.style.display = 'none';
                    currentFabAction = null;
            }
        }

        // Mostrar página
        function showPage(pageId) {
            // Esconder todas as páginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar página solicitada
            const pageElement = document.getElementById(pageId);
            if (pageElement) {
                pageElement.classList.add('active');
                currentPage = pageId;
                
                // Carregar dados da página se necessário
                switch(pageId) {
                    case 'dashboard':
                        loadDashboardData();
                        break;
                    case 'clientes':
                        loadClientes();
                        break;
                    case 'orcamentos':
                        loadOrcamentos();
                        break;
                    case 'ordens':
                        loadOrdens();
                        break;
                    case 'agendamentos':
                        loadAgendamentos();
                        break;
                    case 'configuracoes':
                        updateDatabaseStats();
                        break;
                }
            }
        }

        // Carregar dados do dashboard
        function loadDashboardData() {
            if (!db) {
                setTimeout(loadDashboardData, 100);
                return;
            }
            
            countRecords('clientes', 'totalClientes');
            countRecords('orcamentos', 'totalOrcamentos');
            countRecords('ordens', 'totalOrdens');
            countTodayAgendamentos();
            loadRecentActivities();
        }

        function countRecords(storeName, elementId) {
            if (!db) return;
            
            const transaction = db.transaction([storeName], 'readonly');
            const store = transaction.objectStore(storeName);
            const request = store.count();
            
            request.onsuccess = function() {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = request.result;
                }
            };
            
            request.onerror = function() {
                console.error('Erro ao contar registros:', storeName);
            };
        }

        function countTodayAgendamentos() {
            if (!db) return;
            
            const today = new Date().toISOString().split('T')[0];
            const transaction = db.transaction(['agendamentos'], 'readonly');
            const store = transaction.objectStore('agendamentos');
            const index = store.index('data');
            const range = IDBKeyRange.only(today);
            
            const request = index.count(range);
            
            request.onsuccess = function() {
                const element = document.getElementById('totalAgendamentos');
                if (element) {
                    element.textContent = request.result;
                }
            };
        }

        // Carregar opções de filtro
        function loadFilterOptions() {
            if (!db) return;
            
            // Carregar clientes para filtro de orçamentos
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const clientes = request.result || [];
                const select = document.getElementById('filterClienteOrcamento');
                if (select) {
                    select.innerHTML = '<option value="">Todos os clientes</option>';
                    clientes.forEach(cliente => {
                        select.innerHTML += `<option value="${cliente.id}">${cliente.nome}</option>`;
                    });
                }
            };
        }

        // ========== FUNÇÕES DE MODAL ==========
        function openModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function closeModal() {
            const modal = document.getElementById('modal');
            if (modal) {
                modal.classList.remove('active');
                editingId = null;
                document.getElementById('modalBody').innerHTML = '';
                document.getElementById('modalFooter').innerHTML = '';
            }
        }

        // ========== CLIENTES ==========
        function showClienteForm(cliente = null) {
            editingId = cliente ? cliente.id : null;
            
            document.getElementById('modalTitle').textContent = cliente ? 'Editar Cliente' : 'Novo Cliente';
            
            const formHTML = `
                <div class="form-group">
                    <label for="clienteNome">Nome *</label>
                    <input type="text" id="clienteNome" class="form-control" value="${cliente ? cliente.nome : ''}" placeholder="Nome completo" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteTelefone">Telefone *</label>
                    <input type="tel" id="clienteTelefone" class="form-control" value="${cliente ? cliente.telefone : ''}" placeholder="(11) 99999-9999" required>
                </div>
                
                <div class="form-group">
                    <label for="clienteEmail">E-mail</label>
                    <input type="email" id="clienteEmail" class="form-control" value="${cliente ? cliente.email || '' : ''}" placeholder="email@exemplo.com">
                </div>
                
                <div class="form-group">
                    <label for="clienteEndereco">Endereço</label>
                    <textarea id="clienteEndereco" class="form-control" placeholder="Endereço completo">${cliente ? cliente.endereco || '' : ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label for="clienteObservacoes">Observações</label>
                    <textarea id="clienteObservacoes" class="form-control" placeholder="Observações sobre o cliente">${cliente ? cliente.observacoes || '' : ''}</textarea>
                </div>
            `;
            
            const footerHTML = `
                <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="saveCliente()">Salvar</button>
            `;
            
            document.getElementById('modalBody').innerHTML = formHTML;
            document.getElementById('modalFooter').innerHTML = footerHTML;
            
            openModal();
            
            // Focar no primeiro campo
            setTimeout(() => {
                const nomeInput = document.getElementById('clienteNome');
                if (nomeInput) nomeInput.focus();
            }, 300);
        }

        function saveCliente() {
            const nome = document.getElementById('clienteNome').value.trim();
            const telefone = document.getElementById('clienteTelefone').value.trim();
            const email = document.getElementById('clienteEmail').value.trim();
            const endereco = document.getElementById('clienteEndereco').value.trim();
            const observacoes = document.getElementById('clienteObservacoes').value.trim();
            
            // Validação básica
            if (!nome || !telefone) {
                showToast('Preencha todos os campos obrigatórios', 'warning');
                return;
            }
            
            const cliente = {
                nome: nome,
                telefone: telefone,
                email: email,
                endereco: endereco,
                observacoes: observacoes,
                dataCadastro: new Date().toISOString()
            };
            
            if (editingId) {
                cliente.id = editingId;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const transaction = db.transaction(['clientes'], 'readwrite');
            const store = transaction.objectStore('clientes');
            
            const request = editingId ? store.put(cliente) : store.add(cliente);
            
            request.onsuccess = function() {
                showToast('Cliente salvo com sucesso!', 'success');
                closeModal();
                loadClientes();
                loadDashboardData();
                loadFilterOptions();
                updateDatabaseStats();
                
                // Adicionar atividade
                addAtividade('cliente', editingId ? 'Cliente atualizado' : 'Novo cliente cadastrado', cliente.nome);
            };
            
            request.onerror = function() {
                showToast('Erro ao salvar cliente', 'error');
            };
        }

        function loadClientes(searchTerm = '') {
            if (!db) {
                setTimeout(() => loadClientes(searchTerm), 100);
                return;
            }
            
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onsuccess = function() {
                let clientes = request.result || [];
                
                // Aplicar filtro de busca
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    clientes = clientes.filter(cliente => 
                        cliente.nome.toLowerCase().includes(term) ||
                        cliente.telefone.includes(searchTerm) ||
                        (cliente.email && cliente.email.toLowerCase().includes(term))
                    );
                }
                
                displayClientes(clientes);
            };
            
            request.onerror = function() {
                console.error('Erro ao carregar clientes');
                showToast('Erro ao carregar clientes', 'error');
            };
        }

        function displayClientes(clientes) {
            const container = document.getElementById('listaClientes');
            if (!container) return;
            
            if (!clientes || clientes.length === 0) {
                const searchTerm = document.getElementById('searchCliente')?.value || '';
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>${searchTerm ? 'Nenhum cliente encontrado' : 'Nenhum cliente cadastrado'}</h3>
                        <p>${searchTerm ? 'Tente buscar com outros termos' : 'Adicione seu primeiro cliente'}</p>
                        <button class="btn btn-primary" onclick="showClienteForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Adicionar Cliente
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            clientes.forEach(cliente => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                li.innerHTML = `
                    <div class="list-item-content">
                        <h3>${cliente.nome}</h3>
                        <p><i class="fas fa-phone"></i> ${cliente.telefone} ${cliente.email ? `• <i class="fas fa-envelope"></i> ${cliente.email}` : ''}</p>
                        ${cliente.endereco ? `<p style="font-size: 0.8rem; color: var(--gray); margin-top: 5px;"><i class="fas fa-map-marker-alt"></i> ${cliente.endereco.substring(0, 40)}${cliente.endereco.length > 40 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="list-item-actions">
                        <button class="icon-btn edit" onclick="editCliente(${cliente.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn delete" onclick="deleteCliente(${cliente.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function editCliente(id) {
            if (!db) return;
            
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.get(id);
            
            request.onsuccess = function() {
                if (request.result) {
                    showClienteForm(request.result);
                }
            };
        }

        function deleteCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;
            
            if (!db) return;
            
            const transaction = db.transaction(['clientes'], 'readwrite');
            const store = transaction.objectStore('clientes');
            const request = store.delete(id);
            
            request.onsuccess = function() {
                showToast('Cliente excluído com sucesso', 'success');
                loadClientes();
                loadDashboardData();
                loadFilterOptions();
                updateDatabaseStats();
                addAtividade('cliente', 'Cliente excluído');
            };
        }

        // ========== ORÇAMENTOS ==========
        function showOrcamentoForm(orcamento = null) {
            editingId = orcamento ? orcamento.id : null;
            
            document.getElementById('modalTitle').textContent = orcamento ? 'Editar Orçamento' : 'Novo Orçamento';
            
            // Primeiro carregar clientes
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const clientes = request.result || [];
                const clientesOptions = clientes.map(c => 
                    `<option value="${c.id}" ${orcamento && orcamento.clienteId == c.id ? 'selected' : ''}>${c.nome}</option>`
                ).join('');
                
                const formHTML = `
                    <div class="form-group">
                        <label for="orcamentoClienteId">Cliente *</label>
                        <select id="orcamentoClienteId" class="form-control" required>
                            <option value="">Selecione um cliente</option>
                            ${clientesOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamentoServicos">Serviços *</label>
                        <textarea id="orcamentoServicos" class="form-control" placeholder="Descreva os serviços a serem realizados" required rows="3">${orcamento ? orcamento.servicos : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamentoValor">Valor (R$) *</label>
                        <input type="number" id="orcamentoValor" class="form-control" step="0.01" min="0" value="${orcamento ? orcamento.valor : ''}" placeholder="0,00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamentoValidade">Validade (dias) *</label>
                        <input type="number" id="orcamentoValidade" class="form-control" min="1" max="30" value="${orcamento ? orcamento.validade || 7 : 7}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamentoStatus">Status</label>
                        <select id="orcamentoStatus" class="form-control">
                            <option value="pendente" ${orcamento && orcamento.status === 'pendente' ? 'selected' : 'selected'}>Pendente</option>
                            <option value="aprovado" ${orcamento && orcamento.status === 'aprovado' ? 'selected' : ''}>Aprovado</option>
                            <option value="recusado" ${orcamento && orcamento.status === 'recusado' ? 'selected' : ''}>Recusado</option>
                            <option value="enviado" ${orcamento && orcamento.status === 'enviado' ? 'selected' : ''}>Enviado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="orcamentoObservacoes">Observações</label>
                        <textarea id="orcamentoObservacoes" class="form-control" placeholder="Observações adicionais">${orcamento ? orcamento.observacoes || '' : ''}</textarea>
                    </div>
                `;
                
                const footerHTML = `
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveOrcamento()">Salvar</button>
                    ${orcamento ? `<button type="button" class="btn btn-primary" onclick="converterParaOrdem(${orcamento.id})">
                        <i class="fas fa-exchange-alt"></i> Converter para Ordem
                    </button>` : ''}
                `;
                
                document.getElementById('modalBody').innerHTML = formHTML;
                document.getElementById('modalFooter').innerHTML = footerHTML;
                
                openModal();
            };
        }

        function saveOrcamento() {
            const clienteId = document.getElementById('orcamentoClienteId').value;
            const servicos = document.getElementById('orcamentoServicos').value.trim();
            const valor = parseFloat(document.getElementById('orcamentoValor').value) || 0;
            const validade = parseInt(document.getElementById('orcamentoValidade').value) || 7;
            const status = document.getElementById('orcamentoStatus').value;
            const observacoes = document.getElementById('orcamentoObservacoes').value.trim();
            
            // Validação
            if (!clienteId || !servicos || valor <= 0) {
                showToast('Preencha todos os campos obrigatórios', 'warning');
                return;
            }
            
            const orcamento = {
                clienteId: parseInt(clienteId),
                servicos: servicos,
                valor: valor,
                validade: validade,
                status: status,
                observacoes: observacoes,
                data: new Date().toISOString()
            };
            
            if (editingId) {
                orcamento.id = editingId;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Primeiro buscar nome do cliente
            const clienteTransaction = db.transaction(['clientes'], 'readonly');
            const clienteStore = clienteTransaction.objectStore('clientes');
            const clienteRequest = clienteStore.get(parseInt(clienteId));
            
            clienteRequest.onsuccess = function() {
                const clienteNome = clienteRequest.result ? clienteRequest.result.nome : '';
                
                const transaction = db.transaction(['orcamentos'], 'readwrite');
                const store = transaction.objectStore('orcamentos');
                
                const request = editingId ? store.put(orcamento) : store.add(orcamento);
                
                request.onsuccess = function() {
                    showToast('Orçamento salvo com sucesso!', 'success');
                    closeModal();
                    loadOrcamentos();
                    loadDashboardData();
                    updateDatabaseStats();
                    
                    addAtividade('orcamento', editingId ? 'Orçamento atualizado' : 'Novo orçamento criado', clienteNome, orcamento.status);
                };
                
                request.onerror = function() {
                    showToast('Erro ao salvar orçamento', 'error');
                };
            };
        }

        function converterParaOrdem(orcamentoId) {
            if (!db) return;
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(orcamentoId);
            
            request.onsuccess = function() {
                const orcamento = request.result;
                if (!orcamento) return;
                
                // Criar ordem a partir do orçamento
                const ordem = {
                    clienteId: orcamento.clienteId,
                    servicos: orcamento.servicos,
                    valor: orcamento.valor,
                    prioridade: 'media',
                    status: 'pendente',
                    dataPrazo: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    observacoes: `Convertido do orçamento #${orcamento.id}\n${orcamento.observacoes || ''}`,
                    dataCriacao: new Date().toISOString(),
                    orcamentoId: orcamento.id
                };
                
                // Buscar nome do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(orcamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteNome = clienteRequest.result ? clienteRequest.result.nome : '';
                    
                    // Salvar a ordem
                    const ordemTransaction = db.transaction(['ordens'], 'readwrite');
                    const ordemStore = ordemTransaction.objectStore('ordens');
                    const ordemRequest = ordemStore.add(ordem);
                    
                    ordemRequest.onsuccess = function() {
                        // Atualizar status do orçamento para "aprovado"
                        orcamento.status = 'aprovado';
                        const updateTransaction = db.transaction(['orcamentos'], 'readwrite');
                        const updateStore = updateTransaction.objectStore('orcamentos');
                        updateStore.put(orcamento);
                        
                        showToast('Orçamento convertido para ordem de serviço!', 'success');
                        closeModal();
                        loadOrcamentos();
                        loadOrdens();
                        loadDashboardData();
                        updateDatabaseStats();
                        
                        addAtividade('ordem', 'Ordem criada a partir de orçamento', clienteNome, 'pendente');
                    };
                };
            };
        }

        function loadOrcamentos() {
            if (!db) {
                setTimeout(loadOrcamentos, 100);
                return;
            }
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.getAll();
            
            request.onsuccess = function() {
                let orcamentos = request.result || [];
                
                // Aplicar filtros
                const statusFilter = document.getElementById('filterStatusOrcamento')?.value || '';
                const clienteFilter = document.getElementById('filterClienteOrcamento')?.value || '';
                
                if (statusFilter) {
                    orcamentos = orcamentos.filter(o => o.status === statusFilter);
                }
                
                if (clienteFilter) {
                    orcamentos = orcamentos.filter(o => o.clienteId == clienteFilter);
                }
                
                // Ordenar por data (mais recente primeiro)
                orcamentos.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Buscar nomes dos clientes
                Promise.all(orcamentos.map(orcamento => 
                    new Promise(resolve => {
                        const transaction = db.transaction(['clientes'], 'readonly');
                        const store = transaction.objectStore('clientes');
                        const request = store.get(orcamento.clienteId);
                        request.onsuccess = function() {
                            orcamento.clienteNome = request.result ? request.result.nome : 'Cliente não encontrado';
                            resolve(orcamento);
                        };
                        request.onerror = function() {
                            orcamento.clienteNome = 'Erro ao carregar';
                            resolve(orcamento);
                        };
                    })
                )).then(orcamentosComNomes => {
                    displayOrcamentos(orcamentosComNomes);
                });
            };
        }

        function displayOrcamentos(orcamentos) {
            const container = document.getElementById('listaOrcamentos');
            if (!container) return;
            
            if (!orcamentos || orcamentos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <h3>Nenhum orçamento encontrado</h3>
                        <p>Crie seu primeiro orçamento</p>
                        <button class="btn btn-primary" onclick="showOrcamentoForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Orçamento
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            orcamentos.forEach(orcamento => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const data = new Date(orcamento.data);
                const dataStr = data.toLocaleDateString('pt-BR');
                
                li.innerHTML = `
                    <div class="list-item-content">
                        <h3>Orçamento #${orcamento.id}</h3>
                        <p><i class="fas fa-user"></i> ${orcamento.clienteNome} • <i class="fas fa-calendar"></i> ${dataStr}</p>
                        <p style="font-size: 0.9rem; color: var(--success); font-weight: bold; margin-top: 5px;">
                            <i class="fas fa-money-bill-wave"></i> R$ ${orcamento.valor.toFixed(2)}
                        </p>
                        <span class="status status-${orcamento.status}">${orcamento.status}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="icon-btn view" onclick="viewOrcamento(${orcamento.id})" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn edit" onclick="editOrcamento(${orcamento.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn whatsapp" onclick="sendWhatsAppOrcamento(${orcamento.id})" title="Enviar WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function editOrcamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                if (request.result) {
                    showOrcamentoForm(request.result);
                }
            };
        }

        function viewOrcamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const orcamento = request.result;
                if (!orcamento) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(orcamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    document.getElementById('modalTitle').textContent = `Orçamento #${orcamento.id}`;
                    
                    const data = new Date(orcamento.data);
                    const dataStr = data.toLocaleDateString('pt-BR');
                    
                    const validadeData = new Date(data);
                    validadeData.setDate(validadeData.getDate() + orcamento.validade);
                    const validadeStr = validadeData.toLocaleDateString('pt-BR');
                    
                    const viewHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">${clienteInfo.nome || 'Cliente não encontrado'}</h3>
                            <p><i class="fas fa-calendar"></i> <strong>Data:</strong> ${dataStr}</p>
                            <p><i class="fas fa-clock"></i> <strong>Validade:</strong> ${validadeStr} (${orcamento.validade} dias)</p>
                            <p><strong>Status:</strong> <span class="status status-${orcamento.status}">${orcamento.status}</span></p>
                            ${clienteInfo.telefone ? `<p><i class="fas fa-phone"></i> <strong>Telefone:</strong> ${clienteInfo.telefone}</p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Serviços</h4>
                            <p style="white-space: pre-line; background: var(--light-gray); padding: 15px; border-radius: var(--radius-sm);">${orcamento.servicos}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Valor Total</h4>
                            <p style="font-size: 1.8rem; color: var(--success); font-weight: bold; text-align: center;">
                                <i class="fas fa-money-bill-wave"></i> R$ ${orcamento.valor.toFixed(2)}
                            </p>
                        </div>
                        
                        ${orcamento.observacoes ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Observações</h4>
                            <p>${orcamento.observacoes}</p>
                        </div>
                        ` : ''}
                    `;
                    
                    const footerHTML = `
                        <button type="button" class="btn btn-danger" onclick="closeModal()">Fechar</button>
                        <button type="button" class="btn btn-success" onclick="downloadPDF('orcamento', ${orcamento.id})">
                            <i class="fas fa-download"></i> PDF
                        </button>
                        <button type="button" class="btn" style="background-color: #25D366; color: white;" onclick="sendWhatsAppOrcamento(${orcamento.id})">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button type="button" class="btn btn-primary" onclick="converterParaOrdem(${orcamento.id})">
                            <i class="fas fa-exchange-alt"></i> Ordem
                        </button>
                    `;
                    
                    document.getElementById('modalBody').innerHTML = viewHTML;
                    document.getElementById('modalFooter').innerHTML = footerHTML;
                    
                    openModal();
                };
            };
        }

        function sendWhatsAppOrcamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const orcamento = request.result;
                if (!orcamento) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(orcamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    if (!clienteInfo.telefone) {
                        showToast('Cliente não tem telefone cadastrado', 'warning');
                        return;
                    }
                    
                    const data = new Date(orcamento.data);
                    const dataStr = data.toLocaleDateString('pt-BR');
                    
                    const validadeData = new Date(data);
                    validadeData.setDate(validadeData.getDate() + orcamento.validade);
                    const validadeStr = validadeData.toLocaleDateString('pt-BR');
                    
                    // Criar mensagem para WhatsApp
                    const message = `*${empresaInfo.nome} - Orçamento #${orcamento.id}*

Olá ${clienteInfo.nome}, segue seu orçamento:

*Serviços:*
${orcamento.servicos}

*Valor:* R$ ${orcamento.valor.toFixed(2)}
*Data:* ${dataStr}
*Validade:* ${validadeStr}

${orcamento.observacoes ? `*Observações:*\n${orcamento.observacoes}\n\n` : ''}
Agradecemos a preferência!
${empresaInfo.nome}${empresaInfo.slogan ? ' - ' + empresaInfo.slogan : ''}`;

                    // Codificar mensagem para URL
                    const encodedMessage = encodeURIComponent(message);
                    const phone = clienteInfo.telefone.replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/55${phone}?text=${encodedMessage}`;
                    
                    // Abrir WhatsApp
                    window.open(whatsappUrl, '_blank');
                    
                    // Atualizar status para "Enviado"
                    orcamento.status = 'enviado';
                    const updateTransaction = db.transaction(['orcamentos'], 'readwrite');
                    const updateStore = updateTransaction.objectStore('orcamentos');
                    updateStore.put(orcamento);
                    
                    showToast('Orçamento enviado por WhatsApp', 'success');
                    addAtividade('orcamento', 'Orçamento enviado por WhatsApp', clienteInfo.nome, 'enviado');
                    loadOrcamentos();
                };
            };
        }

        // ========== ORDENS DE SERVIÇO ==========
        function showOrdemForm(ordem = null) {
            editingId = ordem ? ordem.id : null;
            
            document.getElementById('modalTitle').textContent = ordem ? 'Editar Ordem de Serviço' : 'Nova Ordem de Serviço';
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Carregar clientes
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const clientes = request.result || [];
                const clientesOptions = clientes.map(c => 
                    `<option value="${c.id}" ${ordem && ordem.clienteId == c.id ? 'selected' : ''}>${c.nome}</option>`
                ).join('');
                
                const hoje = new Date().toISOString().split('T')[0];
                const prazoPadrao = ordem ? ordem.dataPrazo : new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                
                const formHTML = `
                    <div class="form-group">
                        <label for="ordemClienteId">Cliente *</label>
                        <select id="ordemClienteId" class="form-control" required>
                            <option value="">Selecione um cliente</option>
                            ${clientesOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemServicos">Serviços *</label>
                        <textarea id="ordemServicos" class="form-control" placeholder="Descreva os serviços a serem realizados" required rows="3">${ordem ? ordem.servicos : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemValor">Valor (R$) *</label>
                        <input type="number" id="ordemValor" class="form-control" step="0.01" min="0" value="${ordem ? ordem.valor : ''}" placeholder="0,00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemPrioridade">Prioridade *</label>
                        <select id="ordemPrioridade" class="form-control" required>
                            <option value="alta" ${ordem && ordem.prioridade === 'alta' ? 'selected' : ''}>Alta</option>
                            <option value="media" ${ordem && ordem.prioridade === 'media' ? 'selected' : (ordem ? '' : 'selected')}>Média</option>
                            <option value="baixa" ${ordem && ordem.prioridade === 'baixa' ? 'selected' : ''}>Baixa</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemStatus">Status *</label>
                        <select id="ordemStatus" class="form-control" required>
                            <option value="pendente" ${ordem && ordem.status === 'pendente' ? 'selected' : 'selected'}>Pendente</option>
                            <option value="andamento" ${ordem && ordem.status === 'andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="concluido" ${ordem && ordem.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                            <option value="cancelado" ${ordem && ordem.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemDataPrazo">Prazo de Conclusão *</label>
                        <input type="date" id="ordemDataPrazo" class="form-control" value="${prazoPadrao}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="ordemObservacoes">Observações</label>
                        <textarea id="ordemObservacoes" class="form-control" placeholder="Observações adicionais">${ordem ? ordem.observacoes || '' : ''}</textarea>
                    </div>
                `;
                
                const footerHTML = `
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveOrdem()">Salvar</button>
                `;
                
                document.getElementById('modalBody').innerHTML = formHTML;
                document.getElementById('modalFooter').innerHTML = footerHTML;
                
                openModal();
            };
        }

        function saveOrdem() {
            const clienteId = document.getElementById('ordemClienteId').value;
            const servicos = document.getElementById('ordemServicos').value.trim();
            const valor = parseFloat(document.getElementById('ordemValor').value) || 0;
            const prioridade = document.getElementById('ordemPrioridade').value;
            const status = document.getElementById('ordemStatus').value;
            const dataPrazo = document.getElementById('ordemDataPrazo').value;
            const observacoes = document.getElementById('ordemObservacoes').value.trim();
            
            // Validação
            if (!clienteId || !servicos || valor <= 0 || !dataPrazo) {
                showToast('Preencha todos os campos obrigatórios', 'warning');
                return;
            }
            
            const ordem = {
                clienteId: parseInt(clienteId),
                servicos: servicos,
                valor: valor,
                prioridade: prioridade,
                status: status,
                dataPrazo: dataPrazo,
                observacoes: observacoes,
                dataCriacao: new Date().toISOString()
            };
            
            if (editingId) {
                ordem.id = editingId;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Primeiro buscar nome do cliente
            const clienteTransaction = db.transaction(['clientes'], 'readonly');
            const clienteStore = clienteTransaction.objectStore('clientes');
            const clienteRequest = clienteStore.get(parseInt(clienteId));
            
            clienteRequest.onsuccess = function() {
                const clienteNome = clienteRequest.result ? clienteRequest.result.nome : '';
                
                const transaction = db.transaction(['ordens'], 'readwrite');
                const store = transaction.objectStore('ordens');
                
                const request = editingId ? store.put(ordem) : store.add(ordem);
                
                request.onsuccess = function() {
                    showToast('Ordem salva com sucesso!', 'success');
                    closeModal();
                    loadOrdens();
                    loadDashboardData();
                    updateDatabaseStats();
                    
                    addAtividade('ordem', editingId ? 'Ordem atualizada' : 'Nova ordem criada', clienteNome, ordem.status);
                };
                
                request.onerror = function() {
                    showToast('Erro ao salvar ordem', 'error');
                };
            };
        }

        function loadOrdens() {
            if (!db) {
                setTimeout(loadOrdens, 100);
                return;
            }
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.getAll();
            
            request.onsuccess = function() {
                let ordens = request.result || [];
                
                // Aplicar filtros
                const statusFilter = document.getElementById('filterStatusOrdem')?.value || '';
                const prioridadeFilter = document.getElementById('filterPrioridadeOrdem')?.value || '';
                
                if (statusFilter) {
                    ordens = ordens.filter(o => o.status === statusFilter);
                }
                
                if (prioridadeFilter) {
                    ordens = ordens.filter(o => o.prioridade === prioridadeFilter);
                }
                
                // Ordenar por prioridade e data
                ordens.sort((a, b) => {
                    const priorityOrder = { alta: 3, media: 2, baixa: 1 };
                    const priorityDiff = (priorityOrder[b.prioridade] || 0) - (priorityOrder[a.prioridade] || 0);
                    if (priorityDiff !== 0) return priorityDiff;
                    return new Date(b.dataCriacao) - new Date(a.dataCriacao);
                });
                
                // Buscar nomes dos clientes
                Promise.all(ordens.map(ordem => 
                    new Promise(resolve => {
                        const transaction = db.transaction(['clientes'], 'readonly');
                        const store = transaction.objectStore('clientes');
                        const request = store.get(ordem.clienteId);
                        request.onsuccess = function() {
                            ordem.clienteNome = request.result ? request.result.nome : 'Cliente não encontrado';
                            resolve(ordem);
                        };
                        request.onerror = function() {
                            ordem.clienteNome = 'Erro ao carregar';
                            resolve(ordem);
                        };
                    })
                )).then(ordensComNomes => {
                    displayOrdens(ordensComNomes);
                });
            };
        }

        function displayOrdens(ordens) {
            const container = document.getElementById('listaOrdens');
            if (!container) return;
            
            if (!ordens || ordens.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-list"></i>
                        <h3>Nenhuma ordem encontrada</h3>
                        <p>Crie sua primeira ordem de serviço</p>
                        <button class="btn btn-primary" onclick="showOrdemForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Ordem
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            ordens.forEach(ordem => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                const dataCriacao = new Date(ordem.dataCriacao);
                const dataStr = dataCriacao.toLocaleDateString('pt-BR');
                
                // Verificar se está atrasada
                const hoje = new Date();
                const prazo = new Date(ordem.dataPrazo);
                const atrasada = prazo < hoje && ordem.status !== 'concluido';
                
                li.innerHTML = `
                    <div class="list-item-content">
                        <h3>Ordem #${ordem.id}</h3>
                        <p><i class="fas fa-user"></i> ${ordem.clienteNome} • <i class="fas fa-calendar"></i> ${dataStr}</p>
                        <p style="font-size: 0.9rem; color: var(--success); font-weight: bold; margin-top: 5px;">
                            <i class="fas fa-money-bill-wave"></i> R$ ${ordem.valor.toFixed(2)}
                        </p>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <span class="status status-${ordem.status}">${ordem.status}</span>
                            <span style="display: flex; align-items: center; gap: 5px;">
                                <span class="priority" style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${ordem.prioridade === 'alta' ? 'var(--danger)' : ordem.prioridade === 'media' ? 'var(--warning)' : 'var(--success)'}"></span>
                                ${ordem.prioridade}
                            </span>
                            ${atrasada ? '<span class="status status-cancelado" style="font-size: 0.7rem;">Atrasada</span>' : ''}
                        </div>
                    </div>
                    <div class="list-item-actions">
                        <button class="icon-btn view" onclick="viewOrdem(${ordem.id})" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn edit" onclick="editOrdem(${ordem.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" style="color: ${ordem.status === 'concluido' ? 'var(--success)' : 'var(--warning)'};" onclick="toggleOrdemStatus(${ordem.id})" title="${ordem.status === 'concluido' ? 'Reabrir' : 'Concluir'}">
                            <i class="fas ${ordem.status === 'concluido' ? 'fa-redo' : 'fa-check'}"></i>
                        </button>
                        <button class="icon-btn whatsapp" onclick="sendWhatsAppOrdem(${ordem.id})" title="Enviar WhatsApp">
                            <i class="fab fa-whatsapp"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function editOrdem(id) {
            if (!db) return;
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.get(id);
            
            request.onsuccess = function() {
                if (request.result) {
                    showOrdemForm(request.result);
                }
            };
        }

        function viewOrdem(id) {
            if (!db) return;
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const ordem = request.result;
                if (!ordem) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(ordem.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    document.getElementById('modalTitle').textContent = `Ordem #${ordem.id}`;
                    
                    const dataCriacao = new Date(ordem.dataCriacao);
                    const dataCriacaoStr = dataCriacao.toLocaleDateString('pt-BR');
                    
                    const hoje = new Date();
                    const prazo = new Date(ordem.dataPrazo);
                    const atrasada = prazo < hoje && ordem.status !== 'concluido';
                    
                    const viewHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">${clienteInfo.nome || 'Cliente não encontrado'}</h3>
                            <p><i class="fas fa-calendar-plus"></i> <strong>Criação:</strong> ${dataCriacaoStr}</p>
                            <p><i class="fas fa-calendar-check"></i> <strong>Prazo:</strong> ${ordem.dataPrazo} ${atrasada ? '<span class="status status-cancelado" style="font-size: 0.7rem; margin-left: 5px;">Atrasada</span>' : ''}</p>
                            <p><strong>Status:</strong> <span class="status status-${ordem.status}">${ordem.status}</span></p>
                            <p><strong>Prioridade:</strong> <span style="display: inline-block; width: 12px; height: 12px; border-radius: 50%; background-color: ${ordem.prioridade === 'alta' ? 'var(--danger)' : ordem.prioridade === 'media' ? 'var(--warning)' : 'var(--success)'}; margin-right: 5px;"></span> ${ordem.prioridade}</p>
                            ${clienteInfo.telefone ? `<p><i class="fas fa-phone"></i> <strong>Telefone:</strong> ${clienteInfo.telefone}</p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Serviços</h4>
                            <p style="white-space: pre-line; background: var(--light-gray); padding: 15px; border-radius: var(--radius-sm);">${ordem.servicos}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Valor Total</h4>
                            <p style="font-size: 1.8rem; color: var(--success); font-weight: bold; text-align: center;">
                                <i class="fas fa-money-bill-wave"></i> R$ ${ordem.valor.toFixed(2)}
                            </p>
                        </div>
                        
                        ${ordem.observacoes ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Observações</h4>
                            <p>${ordem.observacoes}</p>
                        </div>
                        ` : ''}
                    `;
                    
                    const footerHTML = `
                        <button type="button" class="btn btn-danger" onclick="closeModal()">Fechar</button>
                        <button type="button" class="btn btn-primary" onclick="editOrdem(${ordem.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn ${ordem.status === 'concluido' ? 'btn-warning' : 'btn-success'}" onclick="toggleOrdemStatus(${ordem.id})">
                            <i class="fas ${ordem.status === 'concluido' ? 'fa-redo' : 'fa-check'}"></i> ${ordem.status === 'concluido' ? 'Reabrir' : 'Concluir'}
                        </button>
                        <button type="button" class="btn" style="background-color: #25D366; color: white;" onclick="sendWhatsAppOrdem(${ordem.id})">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                    `;
                    
                    document.getElementById('modalBody').innerHTML = viewHTML;
                    document.getElementById('modalFooter').innerHTML = footerHTML;
                    
                    openModal();
                };
            };
        }

        function sendWhatsAppOrdem(id) {
            if (!db) return;
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const ordem = request.result;
                if (!ordem) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(ordem.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    if (!clienteInfo.telefone) {
                        showToast('Cliente não tem telefone cadastrado', 'warning');
                        return;
                    }
                    
                    const dataCriacao = new Date(ordem.dataCriacao);
                    const dataStr = dataCriacao.toLocaleDateString('pt-BR');
                    
                    // Criar mensagem para WhatsApp
                    const message = `*${empresaInfo.nome} - Ordem de Serviço #${ordem.id}*

Olá ${clienteInfo.nome}, segue a sua ordem de serviço:

*Serviços:*
${ordem.servicos}

*Valor:* R$ ${ordem.valor.toFixed(2)}
*Data:* ${dataStr}
*Status:* ${ordem.status}
*Prazo:* ${ordem.dataPrazo}
*Prioridade:* ${ordem.prioridade}

${ordem.observacoes ? `*Observações:*\n${ordem.observacoes}\n\n` : ''}
Agradecemos a preferência!
${empresaInfo.nome}${empresaInfo.slogan ? ' - ' + empresaInfo.slogan : ''}`;

                    // Codificar mensagem para URL
                    const encodedMessage = encodeURIComponent(message);
                    const phone = clienteInfo.telefone.replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/55${phone}?text=${encodedMessage}`;
                    
                    // Abrir WhatsApp
                    window.open(whatsappUrl, '_blank');
                    
                    showToast('Ordem enviada por WhatsApp', 'success');
                    addAtividade('ordem', 'Ordem enviada por WhatsApp', clienteInfo.nome, ordem.status);
                };
            };
        }

        function toggleOrdemStatus(id) {
            if (!db) return;
            
            const transaction = db.transaction(['ordens'], 'readwrite');
            const store = transaction.objectStore('ordens');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const ordem = request.result;
                if (!ordem) return;
                
                // Buscar nome do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(ordem.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    if (ordem.status === 'concluido') {
                        ordem.status = 'pendente';
                        ordem.dataConclusao = null;
                        showToast('Ordem reaberta', 'info');
                        addAtividade('ordem', 'Ordem reaberta', clienteInfo.nome, 'pendente');
                    } else {
                        ordem.status = 'concluido';
                        ordem.dataConclusao = new Date().toISOString();
                        showToast('Ordem concluída!', 'success');
                        addAtividade('ordem', 'Ordem concluída', clienteInfo.nome, 'concluido');
                    }
                    
                    store.put(ordem).onsuccess = function() {
                        closeModal();
                        loadOrdens();
                        loadDashboardData();
                    };
                };
            };
        }

        // ========== AGENDAMENTOS ==========
        function showAgendamentoForm(agendamento = null) {
            editingId = agendamento ? agendamento.id : null;
            
            document.getElementById('modalTitle').textContent = agendamento ? 'Editar Agendamento' : 'Novo Agendamento';
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Carregar clientes
            const transaction = db.transaction(['clientes'], 'readonly');
            const store = transaction.objectStore('clientes');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const clientes = request.result || [];
                const clientesOptions = clientes.map(c => 
                    `<option value="${c.id}" ${agendamento && agendamento.clienteId == c.id ? 'selected' : ''}>${c.nome}</option>`
                ).join('');
                
                // Carregar ordens em aberto para o cliente selecionado
                const ordensAbertas = [];
                if (agendamento && agendamento.clienteId) {
                    const ordemTransaction = db.transaction(['ordens'], 'readonly');
                    const ordemStore = ordemTransaction.objectStore('ordens');
                    const ordemRequest = ordemStore.getAll();
                    
                    ordemRequest.onsuccess = function() {
                        const todasOrdens = ordemRequest.result || [];
                        ordensAbertas.push(...todasOrdens.filter(o => 
                            o.clienteId == agendamento.clienteId && 
                            o.status !== 'concluido' && 
                            o.status !== 'cancelado'
                        ));
                    };
                }
                
                const hoje = new Date().toISOString().split('T')[0];
                const amanha = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                const dataAtual = agendamento ? agendamento.data : amanha;
                const horaAtual = agendamento ? agendamento.hora : '09:00';
                
                // Gerar opções de horário
                let timeOptions = '';
                for (let hour = 8; hour <= 18; hour++) {
                    for (let minute = 0; minute < 60; minute += 30) {
                        const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                        timeOptions += `<option value="${time}" ${time === horaAtual ? 'selected' : ''}>${time}</option>`;
                    }
                }
                
                const formHTML = `
                    <div class="form-group">
                        <label for="agendamentoClienteId">Cliente *</label>
                        <select id="agendamentoClienteId" class="form-control" required onchange="carregarOrdensCliente(this.value)">
                            <option value="">Selecione um cliente</option>
                            ${clientesOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoOrdemId">Ordem Relacionada (opcional)</label>
                        <select id="agendamentoOrdemId" class="form-control">
                            <option value="">Nenhuma ordem</option>
                            ${agendamento && agendamento.ordemId ? `<option value="${agendamento.ordemId}" selected>Ordem #${agendamento.ordemId}</option>` : ''}
                        </select>
                        <small style="color: var(--gray);">Selecione uma ordem em aberto para vincular ao agendamento</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoData">Data *</label>
                        <input type="date" id="agendamentoData" class="form-control" value="${dataAtual}" required min="${hoje}">
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoHora">Hora *</label>
                        <select id="agendamentoHora" class="form-control" required>
                            <option value="">Selecione um horário</option>
                            ${timeOptions}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoServicos">Serviços *</label>
                        <textarea id="agendamentoServicos" class="form-control" placeholder="Descreva os serviços agendados" required rows="3">${agendamento ? agendamento.servicos : ''}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoDuracao">Duração Estimada (horas) *</label>
                        <input type="number" id="agendamentoDuracao" class="form-control" min="1" max="8" value="${agendamento ? agendamento.duracao || 1 : 1}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoStatus">Status</label>
                        <select id="agendamentoStatus" class="form-control">
                            <option value="agendado" ${agendamento && agendamento.status === 'agendado' ? 'selected' : 'selected'}>Agendado</option>
                            <option value="confirmado" ${agendamento && agendamento.status === 'confirmado' ? 'selected' : ''}>Confirmado</option>
                            <option value="concluido" ${agendamento && agendamento.status === 'concluido' ? 'selected' : ''}>Concluído</option>
                            <option value="cancelado" ${agendamento && agendamento.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="agendamentoObservacoes">Observações</label>
                        <textarea id="agendamentoObservacoes" class="form-control" placeholder="Observações adicionais">${agendamento ? agendamento.observacoes || '' : ''}</textarea>
                    </div>
                `;
                
                const footerHTML = `
                    <button type="button" class="btn btn-danger" onclick="closeModal()">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveAgendamento()">Salvar</button>
                `;
                
                document.getElementById('modalBody').innerHTML = formHTML;
                document.getElementById('modalFooter').innerHTML = footerHTML;
                
                openModal();
                
                // Carregar ordens se já tiver cliente selecionado
                if (agendamento && agendamento.clienteId) {
                    setTimeout(() => carregarOrdensCliente(agendamento.clienteId), 300);
                }
            };
        }

        function carregarOrdensCliente(clienteId) {
            if (!clienteId || !db) return;
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.getAll();
            
            request.onsuccess = function() {
                const todasOrdens = request.result || [];
                const ordensCliente = todasOrdens.filter(o => 
                    o.clienteId == clienteId && 
                    o.status !== 'concluido' && 
                    o.status !== 'cancelado'
                );
                
                const selectOrdem = document.getElementById('agendamentoOrdemId');
                if (selectOrdem) {
                    selectOrdem.innerHTML = '<option value="">Nenhuma ordem</option>';
                    ordensCliente.forEach(ordem => {
                        selectOrdem.innerHTML += `<option value="${ordem.id}">Ordem #${ordem.id} - ${ordem.servicos.substring(0, 30)}${ordem.servicos.length > 30 ? '...' : ''}</option>`;
                    });
                }
            };
        }

        function saveAgendamento() {
            const clienteId = document.getElementById('agendamentoClienteId').value;
            const ordemId = document.getElementById('agendamentoOrdemId').value;
            const data = document.getElementById('agendamentoData').value;
            const hora = document.getElementById('agendamentoHora').value;
            const servicos = document.getElementById('agendamentoServicos').value.trim();
            const duracao = parseInt(document.getElementById('agendamentoDuracao').value) || 1;
            const status = document.getElementById('agendamentoStatus').value;
            const observacoes = document.getElementById('agendamentoObservacoes').value.trim();
            
            // Validação
            if (!clienteId || !data || !hora || !servicos) {
                showToast('Preencha todos os campos obrigatórios', 'warning');
                return;
            }
            
            const agendamento = {
                clienteId: parseInt(clienteId),
                ordemId: ordemId ? parseInt(ordemId) : null,
                data: data,
                hora: hora,
                servicos: servicos,
                duracao: duracao,
                status: status,
                observacoes: observacoes,
                dataCriacao: new Date().toISOString()
            };
            
            if (editingId) {
                agendamento.id = editingId;
            }
            
            if (!db) {
                showToast('Banco de dados não inicializado', 'error');
                return;
            }
            
            // Primeiro buscar nome do cliente
            const clienteTransaction = db.transaction(['clientes'], 'readonly');
            const clienteStore = clienteTransaction.objectStore('clientes');
            const clienteRequest = clienteStore.get(parseInt(clienteId));
            
            clienteRequest.onsuccess = function() {
                const clienteNome = clienteRequest.result ? clienteRequest.result.nome : '';
                
                const transaction = db.transaction(['agendamentos'], 'readwrite');
                const store = transaction.objectStore('agendamentos');
                
                const request = editingId ? store.put(agendamento) : store.add(agendamento);
                
                request.onsuccess = function() {
                    showToast('Agendamento salvo com sucesso!', 'success');
                    closeModal();
                    loadAgendamentos();
                    loadDashboardData();
                    updateDatabaseStats();
                    
                    addAtividade('agendamento', editingId ? 'Agendamento atualizado' : 'Novo agendamento criado', clienteNome, agendamento.status);
                };
                
                request.onerror = function() {
                    showToast('Erro ao salvar agendamento', 'error');
                };
            };
        }

        function loadAgendamentos() {
            if (!db) {
                setTimeout(loadAgendamentos, 100);
                return;
            }
            
            const transaction = db.transaction(['agendamentos'], 'readonly');
            const store = transaction.objectStore('agendamentos');
            const request = store.getAll();
            
            request.onsuccess = function() {
                let agendamentos = request.result || [];
                
                // Aplicar filtros
                const statusFilter = document.getElementById('filterStatusAgendamento')?.value || '';
                const dataFilter = document.getElementById('filterDataAgendamento')?.value || '';
                
                if (statusFilter) {
                    agendamentos = agendamentos.filter(a => a.status === statusFilter);
                }
                
                if (dataFilter) {
                    agendamentos = agendamentos.filter(a => a.data === dataFilter);
                }
                
                // Ordenar por data e hora
                agendamentos.sort((a, b) => {
                    const dateA = new Date(a.data + 'T' + a.hora);
                    const dateB = new Date(b.data + 'T' + b.hora);
                    return dateA - dateB;
                });
                
                // Buscar nomes dos clientes
                Promise.all(agendamentos.map(agendamento => 
                    new Promise(resolve => {
                        const transaction = db.transaction(['clientes'], 'readonly');
                        const store = transaction.objectStore('clientes');
                        const request = store.get(agendamento.clienteId);
                        request.onsuccess = function() {
                            agendamento.clienteNome = request.result ? request.result.nome : 'Cliente não encontrado';
                            
                            // Buscar info da ordem se houver
                            if (agendamento.ordemId) {
                                const ordemTransaction = db.transaction(['ordens'], 'readonly');
                                const ordemStore = ordemTransaction.objectStore('ordens');
                                const ordemRequest = ordemStore.get(agendamento.ordemId);
                                ordemRequest.onsuccess = function() {
                                    agendamento.ordemInfo = ordemRequest.result;
                                    resolve(agendamento);
                                };
                                ordemRequest.onerror = function() {
                                    resolve(agendamento);
                                };
                            } else {
                                resolve(agendamento);
                            }
                        };
                        request.onerror = function() {
                            agendamento.clienteNome = 'Erro ao carregar';
                            resolve(agendamento);
                        };
                    })
                )).then(agendamentosComNomes => {
                    displayAgendamentos(agendamentosComNomes);
                });
            };
        }

        function displayAgendamentos(agendamentos) {
            const container = document.getElementById('listaAgendamentos');
            if (!container) return;
            
            if (!agendamentos || agendamentos.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>Nenhum agendamento encontrado</h3>
                        <p>Agende seu primeiro serviço</p>
                        <button class="btn btn-primary" onclick="showAgendamentoForm()" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Agendar Serviço
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            agendamentos.forEach(agendamento => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                // Formatar data
                const data = new Date(agendamento.data);
                const dataStr = data.toLocaleDateString('pt-BR', { weekday: 'short', day: 'numeric', month: 'short' });
                
                li.innerHTML = `
                    <div class="list-item-content">
                        <h3>${agendamento.clienteNome}</h3>
                        <p><i class="fas fa-calendar"></i> ${dataStr} • <i class="fas fa-clock"></i> ${agendamento.hora} (${agendamento.duracao}h)</p>
                        <p style="font-size: 0.9rem; color: var(--gray); margin-top: 5px;">${agendamento.servicos.substring(0, 40)}${agendamento.servicos.length > 40 ? '...' : ''}</p>
                        ${agendamento.ordemId ? `<p style="font-size: 0.8rem; color: var(--secondary); margin-top: 5px;"><i class="fas fa-clipboard-list"></i> Ordem #${agendamento.ordemId}</p>` : ''}
                        <span class="status status-${agendamento.status}">${agendamento.status}</span>
                    </div>
                    <div class="list-item-actions">
                        <button class="icon-btn view" onclick="viewAgendamento(${agendamento.id})" title="Visualizar">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="icon-btn edit" onclick="editAgendamento(${agendamento.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="icon-btn" style="color: ${agendamento.status === 'confirmado' ? 'var(--success)' : 'var(--secondary)'};" onclick="toggleConfirmacaoAgendamento(${agendamento.id})" title="${agendamento.status === 'confirmado' ? 'Desconfirmar' : 'Confirmar'}">
                            <i class="fas ${agendamento.status === 'confirmado' ? 'fa-times' : 'fa-check'}"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(li);
            });
        }

        function editAgendamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['agendamentos'], 'readonly');
            const store = transaction.objectStore('agendamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                if (request.result) {
                    showAgendamentoForm(request.result);
                }
            };
        }

        function viewAgendamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['agendamentos'], 'readonly');
            const store = transaction.objectStore('agendamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const agendamento = request.result;
                if (!agendamento) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(agendamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    document.getElementById('modalTitle').textContent = `Agendamento #${agendamento.id}`;
                    
                    const data = new Date(agendamento.data);
                    const dataStr = data.toLocaleDateString('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' });
                    
                    const viewHTML = `
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: var(--primary); margin-bottom: 10px;">${clienteInfo.nome || 'Cliente não encontrado'}</h3>
                            <p><i class="fas fa-calendar"></i> <strong>Data:</strong> ${dataStr}</p>
                            <p><i class="fas fa-clock"></i> <strong>Hora:</strong> ${agendamento.hora}</p>
                            <p><i class="fas fa-hourglass-half"></i> <strong>Duração:</strong> ${agendamento.duracao} hora${agendamento.duracao > 1 ? 's' : ''}</p>
                            <p><strong>Status:</strong> <span class="status status-${agendamento.status}">${agendamento.status}</span></p>
                            ${clienteInfo.telefone ? `<p><i class="fas fa-phone"></i> <strong>Telefone:</strong> ${clienteInfo.telefone}</p>` : ''}
                            ${clienteInfo.endereco ? `<p><i class="fas fa-map-marker-alt"></i> <strong>Endereço:</strong> ${clienteInfo.endereco}</p>` : ''}
                            ${agendamento.ordemId ? `<p><i class="fas fa-clipboard-list"></i> <strong>Ordem Relacionada:</strong> #${agendamento.ordemId}</p>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Serviços Agendados</h4>
                            <p style="white-space: pre-line; background: var(--light-gray); padding: 15px; border-radius: var(--radius-sm);">${agendamento.servicos}</p>
                        </div>
                        
                        ${agendamento.observacoes ? `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--primary); margin-bottom: 10px;">Observações</h4>
                            <p>${agendamento.observacoes}</p>
                        </div>
                        ` : ''}
                    `;
                    
                    const footerHTML = `
                        <button type="button" class="btn btn-danger" onclick="closeModal()">Fechar</button>
                        <button type="button" class="btn btn-primary" onclick="editAgendamento(${agendamento.id})">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        <button type="button" class="btn ${agendamento.status === 'confirmado' ? 'btn-warning' : 'btn-success'}" onclick="toggleConfirmacaoAgendamento(${agendamento.id})">
                            <i class="fas ${agendamento.status === 'confirmado' ? 'fa-times' : 'fa-check'}"></i> ${agendamento.status === 'confirmado' ? 'Desconfirmar' : 'Confirmar'}
                        </button>
                    `;
                    
                    document.getElementById('modalBody').innerHTML = viewHTML;
                    document.getElementById('modalFooter').innerHTML = footerHTML;
                    
                    openModal();
                };
            };
        }

        function toggleConfirmacaoAgendamento(id) {
            if (!db) return;
            
            const transaction = db.transaction(['agendamentos'], 'readwrite');
            const store = transaction.objectStore('agendamentos');
            const request = store.get(id);
            
            request.onsuccess = function() {
                const agendamento = request.result;
                if (!agendamento) return;
                
                // Buscar nome do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(agendamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    if (agendamento.status === 'confirmado') {
                        agendamento.status = 'agendado';
                        showToast('Agendamento desconfirmado', 'info');
                        addAtividade('agendamento', 'Agendamento desconfirmado', clienteInfo.nome, 'agendado');
                    } else {
                        agendamento.status = 'confirmado';
                        showToast('Agendamento confirmado!', 'success');
                        addAtividade('agendamento', 'Agendamento confirmado', clienteInfo.nome, 'confirmado');
                    }
                    
                    store.put(agendamento).onsuccess = function() {
                        closeModal();
                        loadAgendamentos();
                        loadDashboardData();
                    };
                };
            };
        }

        // ========== ATIVIDADES ==========
        function addAtividade(tipo, descricao, clienteNome = '', status = '') {
            if (!db) return;
            
            const atividade = {
                tipo: tipo,
                descricao: descricao,
                clienteNome: clienteNome,
                status: status,
                data: new Date().toISOString()
            };
            
            const transaction = db.transaction(['atividades'], 'readwrite');
            const store = transaction.objectStore('atividades');
            store.add(atividade);
            
            // Atualizar lista de atividades
            loadRecentActivities();
        }

        function loadRecentActivities() {
            if (!db) {
                setTimeout(loadRecentActivities, 100);
                return;
            }
            
            const transaction = db.transaction(['atividades'], 'readonly');
            const store = transaction.objectStore('atividades');
            const index = store.index('data');
            
            const request = index.openCursor(null, 'prev');
            const atividades = [];
            
            request.onsuccess = function(event) {
                const cursor = event.target.result;
                if (cursor && atividades.length < 10) {
                    atividades.push(cursor.value);
                    cursor.continue();
                } else {
                    displayRecentActivities(atividades);
                }
            };
        }

        function displayRecentActivities(atividades) {
            const container = document.getElementById('recentActivities');
            if (!container) return;
            
            if (!atividades || atividades.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clock"></i>
                        <h3>Nenhuma atividade recente</h3>
                        <p>As atividades aparecerão aqui</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            atividades.forEach(atividade => {
                const li = document.createElement('li');
                li.className = 'list-item';
                
                // Icone baseado no tipo
                let icon = '';
                let iconClass = '';
                switch(atividade.tipo) {
                    case 'cliente': 
                        icon = 'fa-user';
                        iconClass = 'var(--primary)';
                        break;
                    case 'orcamento': 
                        icon = 'fa-file-invoice-dollar';
                        iconClass = 'var(--success)';
                        break;
                    case 'ordem': 
                        icon = 'fa-clipboard-check';
                        iconClass = 'var(--warning)';
                        break;
                    case 'agendamento': 
                        icon = 'fa-calendar-alt';
                        iconClass = 'var(--secondary)';
                        break;
                    default:
                        icon = 'fa-bell';
                }
                
                // Formatar data
                const data = new Date(atividade.data);
                const hora = data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                const dataStr = data.toLocaleDateString('pt-BR');
                
                li.innerHTML = `
                    <div class="list-item-content">
                        <h3>${atividade.descricao}</h3>
                        <p>${atividade.clienteNome ? 'Cliente: ' + atividade.clienteNome : ''} • ${dataStr} ${hora}</p>
                        ${atividade.status ? `<span class="status status-${atividade.status}" style="font-size: 0.7rem; margin-top: 5px;">${atividade.status}</span>` : ''}
                    </div>
                    <div><i class="fas ${icon}" style="color: ${iconClass};"></i></div>
                `;
                
                container.appendChild(li);
            });
        }

        // ========== FUNÇÕES DE EXPORTAÇÃO/PDF ==========
        function downloadPDF(tipo, id) {
            if (tipo === 'orcamento') {
                downloadOrcamentoPDF(id);
            } else if (tipo === 'ordem') {
                downloadOrdemPDF(id);
            }
        }

        async function downloadOrcamentoPDF(id) {
            if (!db) return;
            
            const transaction = db.transaction(['orcamentos'], 'readonly');
            const store = transaction.objectStore('orcamentos');
            const request = store.get(id);
            
            request.onsuccess = async function() {
                const orcamento = request.result;
                if (!orcamento) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(orcamento.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    // Usar jsPDF para gerar o PDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Configurações da página
                    const pageWidth = doc.internal.pageSize.width;
                    const margin = 20;
                    
                    // Cabeçalho com informações da empresa
                    doc.setFontSize(18);
                    doc.setTextColor(67, 97, 238);
                    doc.text(empresaInfo.nome, pageWidth / 2, 20, { align: 'center' });
                    
                    if (empresaInfo.slogan) {
                        doc.setFontSize(12);
                        doc.setTextColor(76, 201, 240);
                        doc.text(empresaInfo.slogan, pageWidth / 2, 28, { align: 'center' });
                    }
                    
                    // Linha separadora
                    doc.setDrawColor(67, 97, 238);
                    doc.setLineWidth(1);
                    doc.line(margin, 35, pageWidth - margin, 35);
                    
                    // Título do documento
                    doc.setFontSize(16);
                    doc.setTextColor(33, 37, 41);
                    doc.text(`ORÇAMENTO #${orcamento.id}`, pageWidth / 2, 45, { align: 'center' });
                    
                    // Informações do cliente
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Cliente: ${clienteInfo.nome || ''}`, margin, 60);
                    if (clienteInfo.endereco) {
                        doc.text(`Endereço: ${clienteInfo.endereco}`, margin, 67);
                    }
                    if (clienteInfo.telefone) {
                        doc.text(`Telefone: ${clienteInfo.telefone}`, margin, 74);
                    }
                    
                    // Informações da empresa
                    let empresaY = 60;
                    if (empresaInfo.telefone) {
                        doc.text(`Telefone: ${empresaInfo.telefone}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    if (empresaInfo.email) {
                        doc.text(`Email: ${empresaInfo.email}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    if (empresaInfo.cnpj) {
                        doc.text(`CNPJ: ${empresaInfo.cnpj}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    
                    // Data e validade
                    const data = new Date(orcamento.data);
                    const dataStr = data.toLocaleDateString('pt-BR');
                    const validadeData = new Date(data);
                    validadeData.setDate(validadeData.getDate() + orcamento.validade);
                    const validadeStr = validadeData.toLocaleDateString('pt-BR');
                    
                    doc.text(`Data: ${dataStr}`, margin, 85);
                    doc.text(`Validade: ${validadeStr} (${orcamento.validade} dias)`, margin, 92);
                    
                    // Serviços
                    doc.setFontSize(12);
                    doc.text('DESCRIÇÃO DOS SERVIÇOS', margin, 105);
                    
                    doc.setFontSize(10);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(margin, 107, pageWidth - margin, 107);
                    
                    const servicosLines = doc.splitTextToSize(orcamento.servicos, pageWidth - 2 * margin);
                    doc.text(servicosLines, margin, 115);
                    
                    // Valor
                    const servicosHeight = servicosLines.length * 5;
                    const valorY = 120 + servicosHeight;
                    
                    doc.setFontSize(12);
                    doc.text('VALOR TOTAL', margin, valorY);
                    
                    doc.setFontSize(20);
                    doc.setTextColor(76, 201, 240);
                    doc.text(`R$ ${orcamento.valor.toFixed(2)}`, pageWidth - margin, valorY, { align: 'right' });
                    
                    // Observações
                    if (orcamento.observacoes) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('OBSERVAÇÕES', margin, valorY + 15);
                        
                        doc.setFontSize(10);
                        const obsLines = doc.splitTextToSize(orcamento.observacoes, pageWidth - 2 * margin);
                        doc.text(obsLines, margin, valorY + 23);
                    }
                    
                    // Rodapé
                    const footerY = doc.internal.pageSize.height - 20;
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Documento gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, pageWidth / 2, footerY, { align: 'center' });
                    
                    // Salvar PDF
                    doc.save(`orcamento_${orcamento.id}_${empresaInfo.nome.replace(/\s+/g, '_')}.pdf`);
                    
                    showToast('PDF gerado com sucesso', 'success');
                    addAtividade('orcamento', 'PDF do orçamento gerado', clienteInfo.nome);
                };
            };
        }

        async function downloadOrdemPDF(id) {
            if (!db) return;
            
            const transaction = db.transaction(['ordens'], 'readonly');
            const store = transaction.objectStore('ordens');
            const request = store.get(id);
            
            request.onsuccess = async function() {
                const ordem = request.result;
                if (!ordem) return;
                
                // Buscar informações do cliente
                const clienteTransaction = db.transaction(['clientes'], 'readonly');
                const clienteStore = clienteTransaction.objectStore('clientes');
                const clienteRequest = clienteStore.get(ordem.clienteId);
                
                clienteRequest.onsuccess = function() {
                    const clienteInfo = clienteRequest.result || {};
                    
                    // Usar jsPDF para gerar o PDF
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Configurações da página
                    const pageWidth = doc.internal.pageSize.width;
                    const margin = 20;
                    
                    // Cabeçalho com informações da empresa
                    doc.setFontSize(18);
                    doc.setTextColor(67, 97, 238);
                    doc.text(empresaInfo.nome, pageWidth / 2, 20, { align: 'center' });
                    
                    if (empresaInfo.slogan) {
                        doc.setFontSize(12);
                        doc.setTextColor(76, 201, 240);
                        doc.text(empresaInfo.slogan, pageWidth / 2, 28, { align: 'center' });
                    }
                    
                    // Linha separadora
                    doc.setDrawColor(67, 97, 238);
                    doc.setLineWidth(1);
                    doc.line(margin, 35, pageWidth - margin, 35);
                    
                    // Título do documento
                    doc.setFontSize(16);
                    doc.setTextColor(33, 37, 41);
                    doc.text(`ORDEM DE SERVIÇO #${ordem.id}`, pageWidth / 2, 45, { align: 'center' });
                    
                    // Informações do cliente
                    doc.setFontSize(11);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Cliente: ${clienteInfo.nome || ''}`, margin, 60);
                    if (clienteInfo.endereco) {
                        doc.text(`Endereço: ${clienteInfo.endereco}`, margin, 67);
                    }
                    if (clienteInfo.telefone) {
                        doc.text(`Telefone: ${clienteInfo.telefone}`, margin, 74);
                    }
                    
                    // Informações da ordem
                    const dataCriacao = new Date(ordem.dataCriacao);
                    const dataCriacaoStr = dataCriacao.toLocaleDateString('pt-BR');
                    
                    doc.text(`Data de Criação: ${dataCriacaoStr}`, margin, 85);
                    doc.text(`Prazo: ${ordem.dataPrazo}`, margin, 92);
                    doc.text(`Status: ${ordem.status}`, margin, 99);
                    doc.text(`Prioridade: ${ordem.prioridade}`, margin, 106);
                    
                    // Informações da empresa
                    let empresaY = 85;
                    if (empresaInfo.telefone) {
                        doc.text(`Telefone: ${empresaInfo.telefone}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    if (empresaInfo.email) {
                        doc.text(`Email: ${empresaInfo.email}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    if (empresaInfo.cnpj) {
                        doc.text(`CNPJ: ${empresaInfo.cnpj}`, pageWidth - margin, empresaY, { align: 'right' });
                        empresaY += 7;
                    }
                    
                    // Serviços
                    doc.setFontSize(12);
                    doc.text('DESCRIÇÃO DOS SERVIÇOS', margin, 120);
                    
                    doc.setFontSize(10);
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.5);
                    doc.line(margin, 122, pageWidth - margin, 122);
                    
                    const servicosLines = doc.splitTextToSize(ordem.servicos, pageWidth - 2 * margin);
                    doc.text(servicosLines, margin, 130);
                    
                    // Valor
                    const servicosHeight = servicosLines.length * 5;
                    const valorY = 135 + servicosHeight;
                    
                    doc.setFontSize(12);
                    doc.text('VALOR TOTAL', margin, valorY);
                    
                    doc.setFontSize(20);
                    doc.setTextColor(76, 201, 240);
                    doc.text(`R$ ${ordem.valor.toFixed(2)}`, pageWidth - margin, valorY, { align: 'right' });
                    
                    // Observações
                    if (ordem.observacoes) {
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text('OBSERVAÇÕES', margin, valorY + 15);
                        
                        doc.setFontSize(10);
                        const obsLines = doc.splitTextToSize(ordem.observacoes, pageWidth - 2 * margin);
                        doc.text(obsLines, margin, valorY + 23);
                    }
                    
                    // Rodapé
                    const footerY = doc.internal.pageSize.height - 20;
                    doc.setFontSize(9);
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Documento gerado em: ${new Date().toLocaleDateString('pt-BR')} ${new Date().toLocaleTimeString('pt-BR')}`, pageWidth / 2, footerY, { align: 'center' });
                    
                    // Salvar PDF
                    doc.save(`ordem_${ordem.id}_${empresaInfo.nome.replace(/\s+/g, '_')}.pdf`);
                    
                    showToast('PDF gerado com sucesso', 'success');
                    addAtividade('ordem', 'PDF da ordem gerado', clienteInfo.nome);
                };
            };
        }

        // ========== NOTIFICAÇÕES TOAST ==========
        function showToast(message, type = 'info') {
            // Remover toasts anteriores
            const existingToasts = document.querySelectorAll('.toast-notification');
            existingToasts.forEach(toast => toast.remove());
            
            // Criar elemento toast
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // Remover após 3 segundos
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
